{% extends "base.html" %}

{% block title %}Home - Netflix Recommender{% endblock %}

{% block extra_css %}
<style>
    /* Hero Banner - Using real movie backdrop (Inception from TMDB) */
    .hero-banner {
        height: 70vh;
        background: linear-gradient(to bottom, rgba(20,20,20,0.4), rgba(20,20,20,1)),
                    url('https://image.tmdb.org/t/p/original/s3TBrRGB1iav7gFOCNx3H31MoES.jpg') center/cover;
        display: flex;
        align-items: center;
        padding: 0 4rem;
    }

    /* Movie Card */
    .movie-card {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: #2d2d2d;
        aspect-ratio: 2/3;
    }

    .movie-card:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        z-index: 10;
    }

    .movie-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .movie-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
        padding: 1rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .movie-card:hover .movie-overlay {
        opacity: 1;
    }

    /* Row scroll */
    .movie-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
        padding: 0 4rem;
    }

    @media (max-width: 768px) {
        .movie-row {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            padding: 0 1rem;
        }
        .hero-banner {
            padding: 0 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Banner -->
<div class="hero-banner">
    <div class="max-w-2xl">
        <h1 class="text-5xl md:text-6xl font-bold mb-4">Welcome to Netflix</h1>
        <p class="text-xl mb-6 text-gray-300">
            Discover personalized movie recommendations powered by A/B testing
        </p>
        <div class="flex space-x-4">
            <button id="heroLoginBtn" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded text-lg font-medium transition flex items-center">
                <i class="fas fa-play mr-2"></i>Get Started
            </button>
            <button class="bg-gray-700 bg-opacity-70 hover:bg-opacity-50 px-8 py-3 rounded text-lg font-medium transition flex items-center">
                <i class="fas fa-info-circle mr-2"></i>More Info
            </button>
        </div>
        <p class="text-sm text-gray-400 mt-4">
            <i class="fas fa-flask mr-2"></i>
            This is an A/B testing demo. You'll be assigned to either Control (random) or Treatment (popularity-based) recommendations.
        </p>
    </div>
</div>

<!-- Recommendations Section -->
<div class="py-12">
    <!-- Login prompt -->
    <div id="loginPrompt" class="text-center py-20">
        <i class="fas fa-user-circle text-6xl text-gray-600 mb-4"></i>
        <h2 class="text-3xl font-bold mb-4">Login to See Recommendations</h2>
        <p class="text-gray-400 mb-6">Enter your user ID to get personalized movie suggestions</p>
        <button id="promptLoginBtn" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded text-lg font-medium transition">
            Login Now
        </button>
    </div>

    <!-- Recommendations grid -->
    <div id="recommendationsSection" class="hidden">
        <div class="px-4 md:px-16 mb-8">
            <h2 class="text-2xl font-bold mb-1">Recommended For You</h2>
            <p class="text-sm text-gray-400" id="variantInfo"></p>
        </div>

        <div id="recommendationsGrid" class="movie-row mb-12">
            <!-- Movies will be loaded here -->
        </div>

        <!-- Loading spinner -->
        <div id="loadingSpinner" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-4xl text-red-600"></i>
            <p class="mt-4 text-gray-400">Loading recommendations...</p>
        </div>
    </div>
</div>

<!-- Movie Detail Modal -->
<div id="movieModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg max-w-2xl w-full p-8 relative">
        <button id="closeMovieModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">
            <i class="fas fa-times"></i>
        </button>

        <div id="movieDetails">
            <!-- Movie details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentMovieId = null;
    let modalOpenTime = null;  // Track when modal opens (for dwell time)

    // Hero login button
    document.getElementById('heroLoginBtn').addEventListener('click', () => {
        document.getElementById('loginBtn').click();
    });

    // Prompt login button
    document.getElementById('promptLoginBtn').addEventListener('click', () => {
        document.getElementById('loginBtn').click();
    });

    // Load recommendations
    async function loadRecommendations() {
        const loginPrompt = document.getElementById('loginPrompt');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const recommendationsGrid = document.getElementById('recommendationsGrid');

        // Hide login prompt, show recommendations section
        loginPrompt.classList.add('hidden');
        recommendationsSection.classList.remove('hidden');
        loadingSpinner.classList.remove('hidden');
        recommendationsGrid.innerHTML = '';

        try {
            const response = await fetch('/recommendations');
            const data = await response.json();

            if (data.error) {
                showToast(data.error, 'error');
                loginPrompt.classList.remove('hidden');
                recommendationsSection.classList.add('hidden');
                return;
            }

            // Update variant info
            const variantText = data.variant === 'treatment'
                ? 'Treatment variant (Popularity-based recommendations)'
                : 'Control variant (Random recommendations)';
            document.getElementById('variantInfo').textContent = variantText;

            // Render movie cards
            loadingSpinner.classList.add('hidden');
            renderMovies(data.recommendations);

        } catch (error) {
            console.error('Error loading recommendations:', error);
            showToast('Failed to load recommendations', 'error');
            loadingSpinner.classList.add('hidden');
        }
    }

    function renderMovies(movies) {
        const grid = document.getElementById('recommendationsGrid');

        movies.forEach(movie => {
            const card = createMovieCard(movie);
            grid.appendChild(card);
        });
    }

    function createMovieCard(movie) {
        const card = document.createElement('div');
        card.className = 'movie-card';

        // Get poster URL from movie data (real TMDB posters!)
        const posterUrl = movie.poster_url || `https://via.placeholder.com/300x450/1a1a1a/ffffff?text=${encodeURIComponent(movie.title.substring(0, 20))}`;

        card.innerHTML = `
            <img src="${posterUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Image'" loading="lazy">
            <div class="movie-overlay">
                <h3 class="font-bold text-sm mb-1 line-clamp-2">${movie.title}</h3>
                <p class="text-xs text-gray-400 mb-2">${movie.genres || 'Unknown'}</p>
                ${movie.avg_rating ? `<div class="flex items-center text-xs">
                    <i class="fas fa-star text-yellow-400 mr-1"></i>
                    <span>${movie.avg_rating.toFixed(1)}</span>
                </div>` : ''}
            </div>
        `;

        card.addEventListener('click', () => {
            openMovieModal(movie);
        });

        return card;
    }

    async function openMovieModal(movie) {
        currentMovieId = movie.movieId;

        // DWELL TIME TRACKING: Record when modal opens
        modalOpenTime = Date.now();

        // Log click event
        try {
            await fetch('/click', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({movie_id: movie.movieId})
            });
        } catch (error) {
            console.error('Error logging click:', error);
        }

        // Show modal
        const modal = document.getElementById('movieModal');
        const details = document.getElementById('movieDetails');

        details.innerHTML = `
            <h2 class="text-3xl font-bold mb-4">${movie.title}</h2>

            <div class="flex flex-wrap gap-2 mb-4">
                ${(movie.genres || '').split('|').map(genre =>
                    `<span class="px-3 py-1 bg-gray-800 rounded-full text-sm">${genre}</span>`
                ).join('')}
            </div>

            ${movie.avg_rating ? `
                <div class="flex items-center mb-6">
                    <div class="flex text-yellow-400 mr-2">
                        ${[1,2,3,4,5].map(i =>
                            `<i class="fas fa-star ${i <= Math.round(movie.avg_rating) ? '' : 'opacity-30'}"></i>`
                        ).join('')}
                    </div>
                    <span class="text-lg">${movie.avg_rating.toFixed(1)}/5.0</span>
                </div>
            ` : ''}

            <h3 class="text-xl font-bold mb-3">Rate this movie</h3>
            <div class="flex space-x-3 mb-6">
                ${[1,2,3,4,5].map(rating => `
                    <button class="rating-btn w-12 h-12 rounded-full border-2 border-gray-600 hover:border-red-600 hover:bg-red-600 transition" data-rating="${rating}">
                        ${rating}â˜…
                    </button>
                `).join('')}
            </div>

            <div class="flex space-x-4">
                <button class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded font-medium transition">
                    <i class="fas fa-play mr-2"></i>Play
                </button>
                <button class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded font-medium transition">
                    <i class="fas fa-plus mr-2"></i>My List
                </button>
            </div>
        `;

        modal.classList.remove('hidden');

        // Add rating event listeners
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.addEventListener('click', () => rateMovie(btn.dataset.rating));
        });
    }

    async function logDwellTime(action = 'close') {
        /**
         * Log dwell time (how long user viewed the modal)
         * Engagement metric for A/B testing
         */
        if (modalOpenTime && currentMovieId) {
            const dwellTimeMs = Date.now() - modalOpenTime;

            try {
                await fetch('/api/engagement', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        movie_id: currentMovieId,
                        dwell_time_ms: dwellTimeMs,
                        action: action
                    })
                });

                console.log(`[Engagement] Dwell time: ${dwellTimeMs}ms`);
            } catch (error) {
                console.error('Error logging dwell time:', error);
            }
        }

        // Reset tracking
        modalOpenTime = null;
    }

    async function rateMovie(rating) {
        try {
            const response = await fetch('/rate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    movie_id: currentMovieId,
                    rating: rating
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Rated ${rating} stars!`, 'success');

                // Log dwell time before closing modal
                await logDwellTime('rate');

                document.getElementById('movieModal').classList.add('hidden');
            } else {
                showToast(data.error || 'Rating failed', 'error');
            }
        } catch (error) {
            console.error('Error rating movie:', error);
            showToast('Rating error', 'error');
        }
    }

    // Close modal
    document.getElementById('closeMovieModal').addEventListener('click', async () => {
        // Log dwell time before closing
        await logDwellTime('close');

        document.getElementById('movieModal').classList.add('hidden');
    });

    // Close modal on background click
    document.getElementById('movieModal').addEventListener('click', async (e) => {
        if (e.target.id === 'movieModal') {
            // Log dwell time before closing
            await logDwellTime('background_click');

            document.getElementById('movieModal').classList.add('hidden');
        }
    });
</script>
{% endblock %}
